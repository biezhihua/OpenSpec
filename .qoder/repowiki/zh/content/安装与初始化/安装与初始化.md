# 安装与初始化

<cite>
**本文档中引用的文件**   
- [package.json](file://package.json)
- [bin/openspec.js](file://bin/openspec.js)
- [src/cli/index.ts](file://src/cli/index.ts)
- [src/core/init.ts](file://src/core/init.ts)
- [src/core/config.ts](file://src/core/config.ts)
- [src/core/templates/index.ts](file://src/core/templates/index.ts)
- [src/core/configurators/registry.ts](file://src/core/configurators/registry.ts)
- [src/utils/file-system.ts](file://src/utils/file-system.ts)
- [test/core/init.test.ts](file://test/core/init.test.ts)
- [README.md](file://README.md)
</cite>

## 目录
1. [系统要求](#系统要求)
2. [全局安装](#全局安装)
3. `openspec init` 命令详解
   1. [命令语法与选项](#命令语法与选项)
   2. [交互式模式下的AI工具选择逻辑](#交互式模式下的ai工具选择逻辑)
   3. [非交互式初始化](#非交互式初始化)
4. [项目初始化结构](#项目初始化结构)
5. [初始化流程与文件生成](#初始化流程与文件生成)
6. [常见问题排查](#常见问题排查)

## 系统要求

在安装和使用OpenSpec之前，请确保您的开发环境满足以下系统要求：

- **Node.js**: 版本必须为 `>=20.19.0`。您可以通过在终端运行 `node --version` 命令来检查当前安装的Node.js版本。
- **包管理器**: 支持 `pnpm`, `npm`, 或 `yarn`。其中，`pnpm` 是项目开发时推荐使用的包管理器。

**Section sources**
- [package.json](file://package.json#L55-L57)
- [README.md](file://README.md#L123-L124)

## 全局安装

OpenSpec CLI工具可以通过多种包管理器进行全局安装。以下是推荐的安装方式：

### 使用 pnpm (推荐)
```bash
pnpm add -g @fission-ai/openspec@latest
```

### 使用 npm
```bash
npm install -g @fission-ai/openspec@latest
```

### 使用 yarn
```bash
yarn global add @fission-ai/openspec@latest
```

安装完成后，可以通过以下命令验证安装是否成功：
```bash
openspec --version
```
如果安装成功，该命令将输出OpenSpec的当前版本号。

**Section sources**
- [README.md](file://README.md#L127-L134)

## `openspec init` 命令详解

`openspec init` 是项目初始化的核心命令，用于在您的项目中创建OpenSpec所需的所有文件和目录结构，并配置AI工具。

### 命令语法与选项

该命令的基本语法如下：
```bash
openspec init [path]
```

- `[path]`: 可选参数，指定要初始化的项目路径。如果不提供，则默认为当前目录。

该命令支持以下选项：
- `--tools <tools>`: 用于非交互式地指定要配置的AI工具。其值可以是：
  - `all`: 配置所有可用的AI工具。
  - `none`: 不配置任何原生AI工具。
  - 以逗号分隔的工具ID列表，例如 `claude,cursor`。

**Section sources**
- [src/cli/index.ts](file://src/cli/index.ts#L40-L44)
- [README.md](file://README.md#L144-L146)

### 交互式模式下的AI工具选择逻辑

当不使用 `--tools` 选项时，`openspec init` 会进入交互式模式，引导用户选择AI工具。

1.  **检测模式**: 命令首先检查目标路径下是否已存在 `openspec/` 目录。如果存在，则进入“扩展模式”(extend mode)，否则进入“初始化模式”。
2.  **工具列表生成**: 系统会从 `AI_TOOLS` 配置中筛选出所有可用的工具，并构建一个选择列表。
3.  **选择界面**:
    - **原生支持的工具**: 列出所有提供原生支持的AI工具（如Claude Code, Cursor等），每个工具旁边会显示一个复选框。如果该工具的配置文件已存在且包含OpenSpec标记，则会标注为“(already configured)”。
    - **通用工具 (AGENTS.md)**: 在列表底部会有一个名为“Universal AGENTS.md”的选项，它总是可用的，用于兼容Amp、VS Code、GitHub Copilot等支持AGENTS.md规范的工具。
4.  **用户交互**: 用户可以使用上下键移动光标，空格键切换选择，回车键确认选择并进入审查步骤。
5.  **审查与确认**: 系统会显示用户的选择摘要，用户可以按回车键确认，或按退格键返回修改。

此逻辑的实现核心位于 `src/core/init.ts` 文件中的 `toolSelectionWizard` 函数和 `promptForAITools` 方法。

**Section sources**
- [src/core/init.ts](file://src/core/init.ts#L100-L367)
- [src/core/init.ts](file://src/core/init.ts#L559-L630)
- [src/core/config.ts](file://src/core/config.ts#L19-L37)

### 非交互式初始化

通过 `--tools` 选项，您可以完全跳过交互式选择，实现自动化初始化。

- **指定特定工具**: `openspec init --tools claude,cursor`
- **配置所有工具**: `openspec init --tools all`
- **仅配置通用AGENTS.md**: `openspec init --tools none`

如果提供的工具ID无效，命令将抛出错误并列出所有可用的工具ID。此功能的实现位于 `src/core/init.ts` 文件的 `resolveToolsArg` 方法中。

**Section sources**
- [src/core/init.ts](file://src/core/init.ts#L496-L557)

## 项目初始化结构

执行 `openspec init` 命令后，会在项目根目录下创建一个名为 `openspec/` 的目录，其内部结构如下：

```
openspec/
├── specs/                  # 存放项目当前状态的规范文件
├── changes/                # 存放正在进行的变更提案
│   └── archive/            # 存放已完成并归档的变更
├── AGENTS.md               # OpenSpec指令文件，供AI助手读取
└── project.md              # 项目上下文文件，定义项目级约定
```

- **`openspec/specs/`**: 这是项目的“事实来源”(source of truth)。所有关于系统当前行为的规范都存放在此目录下。
- **`openspec/changes/`**: 此目录用于管理所有变更提案。每个变更都有一个独立的子目录，其中包含提案、任务和规范增量。
- **`AGENTS.md`**: 这是一个核心指令文件，包含了AI助手需要遵循的OpenSpec工作流程。它会被放置在 `openspec/` 目录下，并且一个简化的“存根”(stub)版本也会被创建在项目根目录。
- **`project.md`**: 该文件用于定义项目的整体上下文，如技术栈、架构模式和编码规范，确保所有变更都遵循统一的标准。

**Section sources**
- [README.md](file://README.md#L251-L264)
- [test/core/init.test.ts](file://test/core/init.test.ts#L64-L80)

## 初始化流程与文件生成

`InitCommand` 的执行流程分为以下几个关键步骤：

1.  **验证与模式判断**: 验证目标路径的写入权限，并判断是初始化模式还是扩展模式。
2.  **创建目录结构**: 调用 `createDirectoryStructure` 方法，递归创建 `openspec/`, `specs/`, `changes/` 及其子目录。
3.  **生成核心文件**: 调用 `generateFiles` 方法，使用模板生成 `AGENTS.md` 和 `project.md` 文件。在扩展模式下，此步骤会检查并补充缺失的文件。
4.  **配置AI工具**: 调用 `configureAITools` 方法，根据用户选择，使用相应的 `ToolConfigurator` 来配置AI工具。这包括：
    - 为支持的工具（如Claude, Cursor）创建或更新其配置文件（如 `CLAUDE.md`）。
    - 为支持的工具生成并写入自定义的斜杠命令文件（如 `.claude/commands/openspec/proposal.md`）。
    - 始终在项目根目录创建或更新 `AGENTS.md` 存根文件。

文件生成机制依赖于 `TemplateManager` 类，它管理着所有模板文件。`FileSystemUtils` 类则负责安全地创建目录、读写文件，并使用 `<!-- OPENSPEC:START -->` 和 `<!-- OPENSPEC:END -->` 标记来安全地更新现有文件，确保不会覆盖用户的自定义内容。

**Section sources**
- [src/core/init.ts](file://src/core/init.ts#L385-L459)
- [src/core/init.ts](file://src/core/init.ts#L708-L761)
- [src/core/templates/index.ts](file://src/core/templates/index.ts#L14-L25)
- [src/utils/file-system.ts](file://src/utils/file-system.ts#L129-L165)

## 常见问题排查

结合测试文件中的场景，以下是初始化过程中可能遇到的常见问题及其排查方法：

- **权限错误**: 如果命令报错 `Insufficient permissions to write to ...`，请检查目标目录的写入权限。`InitCommand` 会通过创建一个临时测试文件来验证权限。
- **路径不存在**: 如果指定的路径不存在，命令会尝试创建该目录。如果创建失败（例如由于父目录权限不足），则会抛出错误。
- **文件未正确更新**: 如果AI工具的配置文件（如 `CLAUDE.md`）未被正确更新，可能是因为文件中存在不匹配的OpenSpec标记。系统要求 `<!-- OPENSPEC:START -->` 和 `<!-- OPENSPEC:END -->` 必须成对出现，且结束标记不能在开始标记之前。
- **扩展模式下文件未重建**: 在扩展模式下，如果 `openspec/` 目录下的核心文件（如 `AGENTS.md`, `project.md`）被意外删除，`init` 命令会检测到并自动重新创建它们，以确保项目结构的完整性。
- **非交互式选项错误**: 使用 `--tools` 时，如果输入了无效的工具ID，命令会明确报错并列出所有可用的工具ID，帮助用户修正。

这些场景在 `test/core/init.test.ts` 文件中都有对应的单元测试进行验证，确保了初始化流程的健壮性。

**Section sources**
- [src/core/init.ts](file://src/core/init.ts#L462-L473)
- [src/core/init.ts](file://src/core/init.ts#L657-L706)
- [test/core/init.test.ts](file://test/core/init.test.ts#L645-L683)
- [test/core/init.test.ts](file://test/core/init.test.ts#L685-L693)