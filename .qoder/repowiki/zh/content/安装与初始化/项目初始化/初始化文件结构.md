# 初始化文件结构

<cite>
**本文档中引用的文件**
- [src/core/init.ts](file://src/core/init.ts)
- [src/core/templates/index.ts](file://src/core/templates/index.ts)
- [src/core/templates/project-template.ts](file://src/core/templates/project-template.ts)
- [src/core/templates/agents-template.ts](file://src/core/templates/agents-template.ts)
- [src/core/templates/agents-root-stub.ts](file://src/core/templates/agents-root-stub.ts)
- [src/core/configurators/base.ts](file://src/core/configurators/base.ts)
- [src/core/configurators/registry.ts](file://src/core/configurators/registry.ts)
- [src/core/configurators/claude.ts](file://src/core/configurators/claude.ts)
- [src/core/configurators/slash/registry.ts](file://src/core/configurators/slash/registry.ts)
- [src/core/configurators/slash/claude.ts](file://src/core/configurators/slash/claude.ts)
- [src/core/configurators/slash/qoder.ts](file://src/core/configurators/slash/qoder.ts)
- [src/core/templates/slash-command-templates.ts](file://src/core/templates/slash-command-templates.ts)
- [src/core/config.ts](file://src/core/config.ts)
- [src/utils/file-system.ts](file://src/utils/file-system.ts)
- [test/core/init.test.ts](file://test/core/init.test.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构概览](#项目结构概览)
3. [目录创建逻辑](#目录创建逻辑)
4. [模板系统架构](#模板系统架构)
5. [项目上下文文件](#项目上下文文件)
6. [AI工具配置器](#ai工具配置器)
7. [自定义模板扩展](#自定义模板扩展)
8. [初始化流程详解](#初始化流程详解)
9. [最佳实践与故障排除](#最佳实践与故障排除)

## 简介

OpenSpec的`init`命令为项目提供了一个标准化的初始化流程，自动创建必要的目录结构和配置文件。该系统采用模块化设计，支持多种AI工具集成，并提供了灵活的模板机制来适应不同的项目需求。

## 项目结构概览

OpenSpec初始化后会在项目根目录创建以下核心结构：

```mermaid
graph TB
subgraph "项目根目录"
Root[项目文件]
OpenSpecDir["openspec/"]
ConfigFiles["配置文件<br/>(CLAUDE.md, CLINE.md等)"]
end
subgraph "openspec/ 目录"
OpenSpecDir --> Specs["specs/"]
OpenSpecDir --> Changes["changes/"]
OpenSpecDir --> ProjectMD["project.md"]
OpenSpecDir --> AgentsMD["AGENTS.md"]
subgraph "changes/ 目录"
Changes --> ActiveChanges["活动变更"]
Changes --> Archive["archive/"]
ActiveChanges --> Proposal["proposal.md"]
ActiveChanges --> Tasks["tasks.md"]
ActiveChanges --> Design["design.md"]
ActiveChanges --> SpecsDeltas["specs/"]
end
subgraph "specs/ 目录"
Specs --> Capabilities["功能规范"]
Capabilities --> SpecMD["spec.md"]
Capabilities --> DesignMD["design.md"]
end
end
subgraph "AI工具配置"
ConfigFiles --> ClaudeConfig["CLAUDE.md"]
ConfigFiles --> ClineConfig["CLINE.md"]
ConfigFiles --> OtherConfigs["其他工具配置"]
end
```

**图表来源**
- [src/core/init.ts](file://src/core/init.ts#L708-L718)
- [src/core/templates/index.ts](file://src/core/templates/index.ts#L13-L26)

**章节来源**
- [src/core/init.ts](file://src/core/init.ts#L708-L718)

## 目录创建逻辑

初始化命令首先验证目标路径的有效性，然后创建标准的OpenSpec目录结构：

### 核心目录结构

```mermaid
flowchart TD
Start([开始初始化]) --> ValidatePath["验证目标路径"]
ValidatePath --> CheckExisting{"检查是否已存在"}
CheckExisting --> |不存在| CreateDirs["创建目录结构"]
CheckExisting --> |存在| ExtendMode["扩展模式"]
CreateDirs --> CreateOpenSpec["创建 openspec/"]
CreateOpenSpec --> CreateSpecs["创建 specs/"]
CreateSpecs --> CreateChanges["创建 changes/"]
CreateChanges --> CreateArchive["创建 changes/archive/"]
ExtendMode --> CheckPermissions["检查权限"]
CheckPermissions --> CreateMissing["创建缺失目录"]
CreateMissing --> EnsureFiles["确保模板文件"]
CreateArchive --> GenerateFiles["生成初始文件"]
EnsureFiles --> GenerateFiles
GenerateFiles --> ConfigureTools["配置AI工具"]
ConfigureTools --> Success([初始化完成])
```

**图表来源**
- [src/core/init.ts](file://src/core/init.ts#L417-L459)

### 目录创建步骤

系统按照以下顺序创建目录：

1. **主目录**：`openspec/`
2. **规范目录**：`openspec/specs/`
3. **变更目录**：`openspec/changes/`
4. **归档目录**：`openspec/changes/archive/`

每个目录都使用递归创建方式，确保父目录不存在时也能正确创建。

**章节来源**
- [src/core/init.ts](file://src/core/init.ts#L708-L718)

## 模板系统架构

OpenSpec采用基于TypeScript模块的模板系统，提供类型安全和动态内容注入能力。

### 模板管理器

```mermaid
classDiagram
class TemplateManager {
+getTemplates(context) Template[]
+getClaudeTemplate() string
+getClineTemplate() string
+getCostrictTemplate() string
+getAgentsStandardTemplate() string
+getSlashCommandBody(id) string
}
class Template {
+path string
+content string | function
}
class ProjectContext {
+projectName string
+description string
+techStack string[]
+conventions string
}
TemplateManager --> Template : creates
Template --> ProjectContext : uses
```

**图表来源**
- [src/core/templates/index.ts](file://src/core/templates/index.ts#L13-L35)
- [src/core/templates/project-template.ts](file://src/core/templates/project-template.ts#L1-L38)

### 模板类型

系统支持两种类型的模板：

1. **静态模板**：直接字符串内容
2. **动态模板**：接受ProjectContext参数的函数

**章节来源**
- [src/core/templates/index.ts](file://src/core/templates/index.ts#L13-L35)

## 项目上下文文件

### project.md 文件

`project.md`是项目上下文的核心文件，包含项目的基本信息和约定。

#### 模板结构

```mermaid
flowchart LR
ProjectContext --> ProjectMD["project.md"]
ProjectMD --> Purpose["项目目的"]
ProjectMD --> TechStack["技术栈"]
ProjectMD --> Conventions["项目约定"]
ProjectMD --> DomainContext["领域上下文"]
ProjectMD --> Constraints["重要约束"]
ProjectMD --> Dependencies["外部依赖"]
```

**图表来源**
- [src/core/templates/project-template.ts](file://src/core/templates/project-template.ts#L1-L38)

#### 动态数据注入

项目上下文模板支持以下动态字段：
- `projectName`：项目名称
- `description`：项目描述
- `techStack`：技术栈列表
- `conventions`：项目约定

虽然当前实现中这些字段为空对象，但系统设计支持后续添加交互式提示来收集项目信息。

**章节来源**
- [src/core/templates/project-template.ts](file://src/core/templates/project-template.ts#L1-L38)
- [src/core/init.ts](file://src/core/init.ts#L740-L742)

### AGENTS.md 文件

`AGENTS.md`是AI助手的工作指南，定义了OpenSpec工作流程和最佳实践。

#### 标准模板

系统提供统一的标准模板，所有AI工具共享相同的指令格式：

```mermaid
sequenceDiagram
participant User as 用户
participant Agent as AI助手
participant OpenSpec as OpenSpec系统
User->>Agent : 提交OpenSpec请求
Agent->>Agent : 检查 @/openspec/AGENTS.md
Agent->>OpenSpec : 获取最新指令
OpenSpec-->>Agent : 返回更新后的指令
Agent->>Agent : 执行OpenSpec工作流
Agent-->>User : 返回结果
```

**图表来源**
- [src/core/templates/agents-root-stub.ts](file://src/core/templates/agents-root-stub.ts#L1-L16)
- [src/core/configurators/agents.ts](file://src/core/configurators/agents.ts#L1-L23)

**章节来源**
- [src/core/templates/agents-template.ts](file://src/core/templates/agents-template.ts#L1-L458)
- [src/core/templates/agents-root-stub.ts](file://src/core/templates/agents-root-stub.ts#L1-L16)

## AI工具配置器

OpenSpec支持多种AI工具的自动配置，每种工具都有专门的配置器。

### 工具注册系统

```mermaid
classDiagram
class ToolRegistry {
-tools Map~string, ToolConfigurator~
+register(tool) void
+get(toolId) ToolConfigurator
+getAll() ToolConfigurator[]
+getAvailable() ToolConfigurator[]
}
class ToolConfigurator {
<<interface>>
+name string
+configFileName string
+isAvailable boolean
+configure(projectPath, openspecDir) Promise~void~
}
class ClaudeConfigurator {
+name "Claude Code"
+configFileName "CLAUDE.md"
+isAvailable true
+configure() Promise~void~
}
class ClineConfigurator {
+name "Cline"
+configFileName "CLINE.md"
+isAvailable true
+configure() Promise~void~
}
ToolRegistry --> ToolConfigurator : manages
ToolConfigurator <|-- ClaudeConfigurator
ToolConfigurator <|-- ClineConfigurator
```

**图表来源**
- [src/core/configurators/registry.ts](file://src/core/configurators/registry.ts#L10-L46)
- [src/core/configurators/base.ts](file://src/core/configurators/base.ts#L1-L6)

### 支持的AI工具

系统目前支持以下AI工具：

| 工具名称 | 配置文件 | 标记位置 | 可用性 |
|---------|---------|---------|--------|
| Claude Code | CLAUDE.md | <!-- OPENSPEC:START --> | ✅ |
| Cline | CLINE.md | <!-- OPENSPEC:START --> | ✅ |
| CodeBuddy | CODEBUDDY.md | <!-- OPENSPEC:START --> | ✅ |
| CoStrict | COSTRICT.md | <!-- OPENSPEC:START --> | ✅ |
| Qoder | QODER.md | <!-- OPENSPEC:START --> | ✅ |
| Qwen | QWEN.md | <!-- OPENSPEC:START --> | ✅ |
| AGENTS.md | AGENTS.md | 固定位置 | ⚠️ |

**章节来源**
- [src/core/config.ts](file://src/core/config.ts#L19-L36)
- [src/core/configurators/registry.ts](file://src/core/configurators/registry.ts#L10-L46)

### Slash命令配置

除了基本配置文件，某些工具还支持Slash命令配置：

```mermaid
flowchart TD
ToolSelection["选择AI工具"] --> HasSlashCommands{"支持Slash命令?"}
HasSlashCommands --> |是| CreateSlashFiles["创建Slash命令文件"]
HasSlashCommands --> |否| BasicConfig["基础配置"]
CreateSlashFiles --> ProposalCmd["proposal.md"]
CreateSlashFiles --> ApplyCmd["apply.md"]
CreateSlashFiles --> ArchiveCmd["archive.md"]
ProposalCmd --> ValidateProposal["严格验证提案"]
ApplyCmd --> ImplementChange["实施变更"]
ArchiveCmd --> ArchiveChange["归档变更"]
```

**图表来源**
- [src/core/configurators/slash/registry.ts](file://src/core/configurators/slash/registry.ts#L40-L69)
- [src/core/templates/slash-command-templates.ts](file://src/core/templates/slash-command-templates.ts#L50-L58)

**章节来源**
- [src/core/configurators/slash/claude.ts](file://src/core/configurators/slash/claude.ts#L1-L43)
- [src/core/configurators/slash/qoder.ts](file://src/core/configurators/slash/qoder.ts#L46-L84)

## 自定义模板扩展

OpenSpec提供了灵活的扩展机制，允许开发者添加新的AI工具和自定义模板。

### 新工具注册流程

```mermaid
sequenceDiagram
participant Dev as 开发者
participant Registry as ToolRegistry
participant Configurator as ToolConfigurator
participant SlashRegistry as SlashCommandRegistry
Dev->>Registry : 注册新工具配置器
Registry->>Registry : 添加到工具映射
Dev->>SlashRegistry : 注册Slash命令配置器
SlashRegistry->>SlashRegistry : 添加到命令映射
Note over Registry,SlashRegistry : 新工具现在可用
```

**图表来源**
- [src/core/configurators/registry.ts](file://src/core/configurators/registry.ts#L31-L32)
- [src/core/configurators/slash/registry.ts](file://src/core/configurators/slash/registry.ts#L67-L69)

### 模板扩展点

开发者可以通过以下方式扩展模板系统：

1. **添加新的配置器**：实现`ToolConfigurator`接口
2. **添加Slash命令**：实现`SlashCommandConfigurator`接口
3. **修改现有模板**：更新相应的模板文件
4. **添加新模板类型**：在`TemplateManager`中注册

**章节来源**
- [src/core/configurators/base.ts](file://src/core/configurators/base.ts#L1-L6)
- [src/core/configurators/slash/base.ts](file://src/core/configurators/slash/base.ts)

## 初始化流程详解

### 完整初始化序列

```mermaid
sequenceDiagram
participant CLI as CLI命令
participant Init as InitCommand
participant FS as 文件系统
participant Templates as 模板系统
participant Tools as 工具配置器
CLI->>Init : 执行 init 命令
Init->>FS : 验证目标路径
Init->>Init : 检查扩展模式
alt 新建初始化
Init->>FS : 创建目录结构
Init->>Templates : 生成初始文件
else 扩展模式
Init->>FS : 创建缺失目录
Init->>Templates : 确保模板文件
end
Init->>Tools : 配置选定的AI工具
loop 每个选定工具
Tools->>FS : 写入配置文件
Tools->>Tools : 生成Slash命令
end
Init->>Init : 显示成功消息
```

**图表来源**
- [src/core/init.ts](file://src/core/init.ts#L385-L459)

### 错误处理机制

系统实现了完善的错误处理和回滚机制：

1. **权限检查**：初始化前验证写入权限
2. **原子操作**：目录创建采用原子方式
3. **回滚支持**：失败时清理已创建的文件
4. **状态检测**：智能识别现有配置状态

**章节来源**
- [src/core/init.ts](file://src/core/init.ts#L462-L472)
- [src/core/init.ts](file://src/core/init.ts#L763-L806)

## 最佳实践与故障排除

### 初始化最佳实践

1. **目录结构**：保持项目根目录整洁，避免与其他工具冲突
2. **权限管理**：确保有足够的写入权限
3. **工具选择**：根据团队使用的AI工具选择合适的配置
4. **扩展模式**：使用`openspec update`而非重复初始化

### 常见问题解决

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 权限不足 | 目标目录无写入权限 | 使用sudo或更改目录权限 |
| 已初始化 | 项目已包含OpenSpec结构 | 使用`openspec update`命令 |
| 工具配置失败 | 配置文件被手动修改 | 删除配置文件重新初始化 |
| Slash命令不工作 | 工具不支持Slash命令 | 检查工具文档或使用通用AGENTS.md |

### 测试验证

系统提供了完整的测试覆盖，包括：

- 目录结构创建测试
- 模板文件生成测试
- AI工具配置测试
- 扩展模式测试
- 错误处理测试

**章节来源**
- [test/core/init.test.ts](file://test/core/init.test.ts#L647-L689)