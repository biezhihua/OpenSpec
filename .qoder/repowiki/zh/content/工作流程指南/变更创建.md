# 变更创建

<cite>
**本文档引用的文件**
- [README.md](file://README.md)
- [AGENTS.md](file://AGENTS.md)
- [item-discovery.ts](file://src/utils/item-discovery.ts)
- [cli/index.ts](file://src/cli/index.ts)
- [commands/validate.ts](file://src/commands/validate.ts)
- [changes/add-scaffold-command/proposal.md](file://openspec/changes/add-scaffold-command/proposal.md)
- [changes/add-scaffold-command/tasks.md](file://openspec/changes/add-scaffold-command/tasks.md)
- [changes/add-scaffold-command/specs/cli-scaffold/spec.md](file://openspec/changes/add-scaffold-command/specs/cli-scaffold/spec.md)
</cite>

## 目录
1. [简介](#简介)
2. [选择变更ID](#选择变更id)
3. [使用scaffold命令生成变更结构](#使用scaffold命令生成变更结构)
4. [创建提案文件](#创建提案文件)
5. [编写规范文件](#编写规范文件)
6. [验证变更](#验证变更)
7. [变更发现机制](#变更发现机制)

## 简介
本文档详细指导用户如何在OpenSpec系统中创建新的变更提案。通过遵循本指南，用户可以正确地选择变更ID、生成变更目录结构、创建必要的提案文件，并确保变更符合系统规范。文档结合了AGENTS.md中的工作流程指南，强调了在共享提案前进行验证的重要性。

## 选择变更ID
在创建新变更之前，必须选择一个唯一的变更ID。变更ID应遵循以下命名约定：
- 使用kebab-case（短横线分隔）格式
- 以动词开头，如`add-`、`update-`、`remove-`或`refactor-`
- 简短且具有描述性，准确反映变更的目的
- 确保在整个项目中唯一，如果名称已被使用，可以添加`-2`、`-3`等后缀

选择一个清晰的变更ID有助于团队成员理解变更的意图，并避免与其他变更发生冲突。

**Section sources**
- [AGENTS.md](file://AGENTS.md#L399-L403)

## 使用scaffold命令生成变更结构
使用`openspec scaffold`命令可以自动生成变更的目录结构和模板文件。该命令会创建一个符合OpenSpec规范的变更框架，包括`proposal.md`、`tasks.md`和`specs`子目录。

执行以下命令来生成变更结构：
```bash
openspec scaffold <change-id>
```

此命令将自动创建以下文件和目录：
- `openspec/changes/<change-id>/proposal.md`
- `openspec/changes/<change-id>/tasks.md`
- `openspec/changes/<change-id>/design.md`（可选）
- `openspec/changes/<change-id>/specs/`（用于存放规范文件）

**Section sources**
- [add-scaffold-command/proposal.md](file://openspec/changes/add-scaffold-command/proposal.md#L5-L6)
- [add-scaffold-command/tasks.md](file://openspec/changes/add-scaffold-command/tasks.md#L2-L3)

## 创建提案文件
在变更目录中需要创建三个主要文件：`proposal.md`、`tasks.md`和可选的`design.md`。

### proposal.md
`proposal.md`文件包含变更的概述，包括：
- **Why**：解释变更的原因和机会
- **What Changes**：列出具体的变更内容
- **Impact**：说明受影响的规范和代码

### tasks.md
`tasks.md`文件包含实现变更的检查清单，格式如下：
```markdown
## 1. Implementation
- [ ] 1.1 Create database schema
- [ ] 1.2 Implement API endpoint
- [ ] 1.3 Add frontend component
- [ ] 1.4 Write tests
```

### design.md
当变更涉及跨系统修改、新架构模式或复杂的技术决策时，才需要创建`design.md`文件。

**Section sources**
- [AGENTS.md](file://AGENTS.md#L157-L208)
- [add-scaffold-command/specs/cli-scaffold/spec.md](file://openspec/changes/add-scaffold-command/specs/cli-scaffold/spec.md#L20-L27)

## 编写规范文件
在变更目录中创建`specs`子目录，并在其中编写`spec.md`文件。规范文件使用Delta格式来描述变更，包括以下指令：

### ADDED指令
用于添加新的功能或能力：
```markdown
## ADDED Requirements
### Requirement: New Feature
The system SHALL provide...
```

### MODIFIED指令
用于修改现有行为，需要包含完整的更新后内容：
```markdown
## MODIFIED Requirements
### Requirement: Existing Feature
[Complete modified requirement]
```

### REMOVED指令
用于标记已弃用的功能：
```markdown
## REMOVED Requirements
### Requirement: Old Feature
**Reason**: [Why removing]
**Migration**: [How to handle]
```

每个需求必须至少包含一个场景，使用`#### Scenario:`格式。

**Section sources**
- [AGENTS.md](file://AGENTS.md#L320-L324)
- [AGENTS.md](file://AGENTS.md#L259-L263)

## 验证变更
在共享提案之前，必须运行`openspec validate`命令进行检查。这可以确保变更符合OpenSpec的格式要求，并避免后续问题。

执行以下命令进行验证：
```bash
openspec validate <change-id> --strict
```

验证过程会检查：
- 变更是否至少包含一个Delta
- 每个需求是否至少有一个场景
- 规范文件格式是否正确

如果验证失败，根据错误提示进行修正，直到验证通过为止。

**Section sources**
- [AGENTS.md](file://AGENTS.md#L47-L48)
- [commands/validate.ts](file://src/commands/validate.ts#L130-L136)

## 变更发现机制
系统通过`item-discovery.ts`文件中的`getActiveChangeIds`函数自动发现新创建的变更。该函数会扫描`openspec/changes/`目录，查找包含`proposal.md`文件的子目录，并返回所有活动变更的ID列表。

```typescript
export async function getActiveChangeIds(root: string = process.cwd()): Promise<string[]> {
  const changesPath = path.join(root, 'openspec', 'changes');
  try {
    const entries = await fs.readdir(changesPath, { withFileTypes: true });
    const result: string[] = [];
    for (const entry of entries) {
      if (!entry.isDirectory() || entry.name.startsWith('.') || entry.name === 'archive') continue;
      const proposalPath = path.join(changesPath, entry.name, 'proposal.md');
      try {
        await fs.access(proposalPath);
        result.push(entry.name);
      } catch {
        // skip directories without proposal.md
      }
    }
    return result.sort();
  } catch {
    return [];
  }
}
```

这个机制确保了所有有效的变更都能被系统识别和处理。

**Section sources**
- [item-discovery.ts](file://src/utils/item-discovery.ts#L4-L19)
- [cli/index.ts](file://src/cli/index.ts#L97-L100)