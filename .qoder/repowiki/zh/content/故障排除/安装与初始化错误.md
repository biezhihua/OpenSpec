# 安装与初始化错误故障排除指南

<cite>
**本文档中引用的文件**
- [init.test.ts](file://test/core/init.test.ts)
- [init.ts](file://src/core/init.ts)
- [cli/index.ts](file://src/cli/index.ts)
- [config.ts](file://src/core/config.ts)
- [file-system.ts](file://src/utils/file-system.ts)
- [package.json](file://package.json)
- [README.md](file://README.md)
- [agents-root-stub.ts](file://src/core/templates/agents-root-stub.ts)
</cite>

## 目录
1. [简介](#简介)
2. [常见错误类型](#常见错误类型)
3. [详细故障排除指南](#详细故障排除指南)
4. [错误信息解读](#错误信息解读)
5. [调试技巧](#调试技巧)
6. [诊断信息收集](#诊断信息收集)
7. [预防措施](#预防措施)
8. [总结](#总结)

## 简介

OpenSpec CLI 是一个用于 AI 驱动规范开发的命令行工具。在安装和初始化过程中，用户可能会遇到各种错误。本指南基于 `init.test.ts` 中的测试用例和实际代码实现，提供了全面的故障排除方法。

## 常见错误类型

根据测试用例和代码分析，OpenSpec 初始化过程中可能遇到以下主要错误类型：

### 1. 目标目录相关错误
- 目标路径不存在且无法创建
- 目标路径不是有效目录
- 权限不足导致写入失败

### 2. AI 工具配置错误
- 无可用的选择队列（No queued selections provided）
- AI 工具配置文件更新失败
- 多工具集成冲突

### 3. 文件系统权限错误
- 写入权限不足（EACCES: permission denied）
- 目录创建失败
- 文件读取/写入异常

### 4. 环境配置错误
- CODEX_HOME 环境变量设置不当
- 全局配置文件冲突
- 路径解析错误

## 详细故障排除指南

### 错误：No queued selections provided

**症状描述：**
```
Error: No queued selections provided to init prompt.
```

**根本原因：**
这是交互式初始化过程中的预期错误，表示没有提供 AI 工具选择队列。通常发生在测试环境中，但在某些自动化场景下也可能出现。

**解决方法：**

1. **确保正确使用交互模式**
   ```bash
   # 正确方式：启动交互式初始化
   openspec init
   
   # 或者使用非交互模式指定工具
   openspec init --tools claude,cursor
   ```

2. **检查非交互模式参数**
   ```bash
   # 使用预设工具列表
   openspec init --tools all
   
   # 指定特定工具
   openspec init --tools claude,cursor,windsurf
   ```

3. **验证工具可用性**
   根据 `AI_TOOLS` 配置，确认您选择的工具是否可用：
   ```javascript
   // 可用工具列表
   const availableTools = [
     'auggie', 'claude', 'cline', 'codebuddy', 'costrict', 
     'crush', 'cursor', 'factory', 'opencode', 'kilocode', 
     'qoder', 'windsurf', 'codex', 'github-copilot', 
     'amazon-q', 'qwen'
   ];
   ```

**节来源**
- [init.test.ts](file://test/core/init.test.ts#L14-L18)
- [init.ts](file://src/core/init.ts#L586-L630)

### 错误：Insufficient permissions to write to [path]

**症状描述：**
```
Error: Insufficient permissions to write to [project-path]
```

**根本原因：**
文件系统权限不足，无法在目标目录创建 OpenSpec 结构。

**解决方法：**

1. **检查目录权限**
   ```bash
   # 检查当前目录权限
   ls -la .
   
   # 如果需要，修改目录权限
   chmod 755 .
   ```

2. **使用 sudo（谨慎使用）**
   ```bash
   sudo openspec init
   ```

3. **选择可写目录**
   ```bash
   # 移动到有写权限的目录
   cd ~/projects
   openspec init
   ```

4. **检查父目录权限**
   ```bash
   # 检查父目录权限
   ls -la ~/projects
   ```

**节来源**
- [init.ts](file://src/core/init.ts#L468-L471)
- [file-system.ts](file://src/utils/file-system.ts#L167-L186)

### 错误：Directory "[path]" doesn't exist, it will be created

**症状描述：**
CLI 输出显示目标目录不存在，但会自动创建。

**根本原因：**
目标路径不存在，但 CLI 会尝试创建该目录。

**解决方法：**

1. **确认目录创建成功**
   ```bash
   # 检查目录是否已创建
   ls -la [target-path]
   ```

2. **手动创建目录（如果需要）**
   ```bash
   mkdir -p [target-path]
   ```

3. **验证目录权限**
   ```bash
   # 确保目录具有适当的权限
   chmod 755 [target-path]
   ```

**节来源**
- [cli/index.ts](file://src/cli/index.ts#L47-L62)

### 错误：Copy these prompts to your AGENTS.md-compatible assistant

**症状描述：**
成功初始化后的提示信息，表示需要将生成的提示复制到兼容的 AI 助手。

**根本原因：**
这是成功完成初始化的标准输出，表示 OpenSpec 已正确配置。

**解决方法：**

1. **识别兼容的 AI 工具**
   根据初始化时选择的工具，找到对应的配置文件：
   - Claude Code: CLAUDE.md
   - Cursor: .cursor/commands/
   - GitHub Copilot: .github/prompts/
   - Codex: .codex/prompts/

2. **复制提示内容**
   将输出中的提示内容复制到相应配置文件中。

3. **验证配置**
   ```bash
   # 检查生成的文件
   ls -la openspec/
   cat openspec/AGENTS.md
   ```

**节来源**
- [init.test.ts](file://test/core/init.test.ts#L702-L714)
- [agents-root-stub.ts](file://src/core/templates/agents-root-stub.ts#L1-L17)

### 错误：EACCES: permission denied

**症状描述：**
```
Error: EACCES: permission denied
```

**根本原因：**
文件系统权限严重不足，无法执行任何文件操作。

**解决方法：**

1. **检查文件所有者**
   ```bash
   # 查看文件权限
   ls -la [file-path]
   
   # 修改文件所有者
   sudo chown $USER:$USER [file-path]
   ```

2. **修复目录权限**
   ```bash
   # 递归修复权限
   sudo chmod -R 755 [directory-path]
   ```

3. **检查磁盘空间**
   ```bash
   df -h
   ```

**节来源**
- [file-system.ts](file://src/utils/file-system.ts#L182-L186)

## 错误信息解读

### 1. 交互式提示错误

**"No queued selections provided to init prompt."**
- **含义**: 交互式初始化缺少必要的工具选择
- **解决方案**: 提供工具选择或使用非交互模式

**"Which natively supported AI tools do you use?"**
- **含义**: 系统正在询问要配置的 AI 工具
- **解决方案**: 使用方向键选择工具，按空格键切换选择

### 2. 成功消息

**"Copy these prompts to your AGENTS.md-compatible assistant"**
- **含义**: 表示初始化成功，需要配置 AI 助手
- **解决方案**: 根据提示将内容复制到相应的配置文件

**"AI tools configured"**
- **含义**: 所选 AI 工具已成功配置
- **解决方案**: 继续后续步骤

### 3. 错误消息

**"Insufficient permissions to write to [path]"**
- **含义**: 当前用户没有写入目标目录的权限
- **解决方案**: 修改目录权限或使用具有足够权限的用户

**"Directory '[path]' doesn't exist, it will be created"**
- **含义**: 目标目录不存在，CLI 将自动创建
- **解决方案**: 确认目录创建成功

## 调试技巧

### 1. 检查环境变量 CODEX_HOME

**用途**: 控制 Codex 工具的全局配置位置

**检查方法**:
```bash
# 查看当前设置
echo $CODEX_HOME

# 在初始化时临时设置
CODEX_HOME=~/.codex openspec init
```

**调试步骤**:
```bash
# 1. 检查环境变量
echo "CODEX_HOME: $CODEX_HOME"

# 2. 尝试不同的值
export CODEX_HOME=/tmp/codex-test
openspec init

# 3. 清理环境变量
unset CODEX_HOME
```

### 2. 启用详细日志

**方法**: 通过修改源码或使用调试模式

**注意事项**:
- 不建议直接修改生产代码
- 使用测试环境进行调试

### 3. 验证文件系统状态

```bash
# 检查磁盘空间
df -h

# 检查文件权限
ls -la [target-path]

# 检查目录结构
find [target-path] -type d -print

# 检查文件内容
cat [file-path]
```

### 4. 测试基本功能

```bash
# 验证 CLI 可用性
openspec --version

# 测试基本命令
openspec list

# 检查配置文件
ls -la openspec/
```

## 诊断信息收集

### 必需信息清单

1. **系统信息**
   ```bash
   # 操作系统版本
   uname -a
   
   # Node.js 版本
   node --version
   
   # OpenSpec 版本
   openspec --version
   ```

2. **环境信息**
   ```bash
   # 环境变量
   env | grep -E "(NODE_|OPENSPEC_|CODEX_)"

   # PATH 设置
   echo $PATH
   ```

3. **目录状态**
   ```bash
   # 目标目录信息
   ls -la [target-path]
   stat [target-path]

   # 权限检查
   getfacl [target-path]
   ```

4. **错误重现步骤**
   - 完整的命令序列
   - 环境配置详情
   - 错误发生的具体上下文

### 收集脚本

```bash
#!/bin/bash
# OpenSpec 诊断脚本

echo "=== OpenSpec 诊断信息 ==="
echo "时间: $(date)"
echo

echo "=== 系统信息 ==="
echo "操作系统: $(uname -a)"
echo "Node.js 版本: $(node --version)"
echo "OpenSpec 版本: $(openspec --version 2>/dev/null || echo '未安装')"
echo

echo "=== 环境变量 ==="
env | grep -E "(NODE_|OPENSPEC_|CODEX_)" | sort
echo

echo "=== 目录状态 ==="
TARGET_PATH="${1:-.}"
echo "目标路径: $TARGET_PATH"
ls -la "$TARGET_PATH"
echo

echo "=== 权限检查 ==="
stat "$TARGET_PATH"
echo

echo "=== 依赖检查 ==="
which node npm openspec 2>/dev/null || echo "工具未找到"
echo

echo "=== 最后错误 ==="
echo "最后命令: $BASH_COMMAND"
echo "退出状态: $?"
```

## 预防措施

### 1. 系统准备

**前置条件检查**:
```bash
# 检查 Node.js 版本
NODE_VERSION=$(node --version | cut -d'.' -f1 | sed 's/v//')
if [ "$NODE_VERSION" -lt 20 ]; then
    echo "错误: 需要 Node.js >= 20.19.0"
    exit 1
fi

# 检查 npm
which npm >/dev/null || { echo "错误: npm 未安装"; exit 1; }
```

**目录权限预检查**:
```bash
# 检查写入权限
TEST_FILE="$HOME/.openspec-test-$(date +%s)"
touch "$TEST_FILE" 2>/dev/null && rm "$TEST_FILE" || {
    echo "警告: 当前用户没有写入权限"
    exit 1
}
```

### 2. 安装最佳实践

**全局安装**:
```bash
# 升级到最新版本
npm install -g @fission-ai/openspec@latest

# 验证安装
openspec --version
```

**本地安装（可选）**:
```bash
# 在项目目录中安装
npm install @fission-ai/openspec

# 使用 npx 运行
npx openspec --version
```

### 3. 初始化策略

**逐步初始化**:
```bash
# 1. 创建新项目目录
mkdir my-project && cd $_

# 2. 初始化 OpenSpec
openspec init

# 3. 验证初始化结果
openspec list
```

**批量初始化**:
```bash
# 使用非交互模式
openspec init --tools all

# 指定多个工具
openspec init --tools claude,cursor,windsurf
```

### 4. 后续维护

**定期更新**:
```bash
# 更新 CLI
npm install -g @fission-ai/openspec@latest

# 刷新配置
openspec update
```

**配置备份**:
```bash
# 备份 OpenSpec 目录
tar -czf openspec-backup.tar.gz openspec/

# 备份配置文件
cp openspec/AGENTS.md openspec/AGENTS.md.backup
```

## 总结

OpenSpec 的安装和初始化过程虽然设计得相对健壮，但仍可能遇到各种错误。通过本指南提供的故障排除方法，用户可以：

1. **快速识别问题**: 通过错误信息和症状描述准确定位问题
2. **系统化解决**: 按照指南步骤逐一排查和解决问题
3. **预防潜在问题**: 采用最佳实践避免常见错误
4. **有效收集信息**: 准备充分的诊断信息以便获得技术支持

记住，在遇到复杂问题时，始终优先收集完整的诊断信息，并参考官方文档或社区支持资源。OpenSpec 社区活跃，许多常见问题都有现成的解决方案。