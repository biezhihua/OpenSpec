# 配置与自定义

<cite>
**本文档中引用的文件**  
- [config.ts](file://src/core/config.ts)
- [project.md](file://openspec/project.md)
- [agents-template.ts](file://src/core/templates/agents-template.ts)
- [project-template.ts](file://src/core/templates/project-template.ts)
- [init.ts](file://src/core/init.ts)
- [update.ts](file://src/core/update.ts)
- [agents.ts](file://src/core/configurators/agents.ts)
- [slash-command-templates.ts](file://src/core/templates/slash-command-templates.ts)
</cite>

## 目录
1. [配置机制与默认值](#配置机制与默认值)
2. [project.md 文件结构与作用](#projectmd-文件结构与作用)
3. [模板系统工作原理](#模板系统工作原理)
4. [高级配置选项](#高级配置选项)
5. [配置最佳实践与用例](#配置最佳实践与用例)

## 配置机制与默认值

OpenSpec 的配置机制主要通过 `src/core/config.ts` 文件定义，该文件导出了核心配置常量和接口。`OPENSPEC_DIR_NAME` 常量定义了项目中 OpenSpec 目录的默认名称为 `openspec`，而 `OPENSPEC_MARKERS` 对象定义了用于标记文件中 OpenSpec 内容开始和结束的特殊注释，分别是 `<!-- OPENSPEC:START -->` 和 `<!-- OPENSPEC:END -->`。这些标记确保了 OpenSpec 工具能够安全地更新文件内容而不会破坏用户原有的内容。

配置的核心是 `OpenSpecConfig` 接口，它定义了一个包含 `aiTools` 字符串数组的配置对象，用于指定项目中启用的 AI 工具。`AIToolOption` 接口则描述了每个 AI 工具的详细信息，包括名称、值、可用性以及成功标签。`AI_TOOLS` 常量是一个 `AIToolOption` 对象的数组，它列出了所有支持的 AI 工具，如 Auggie、Claude Code、Cline、CodeBuddy Code 等。每个工具都有一个唯一的 `value` 作为其标识符，并且 `available` 字段为 `true` 表示该工具当前可用。值得注意的是，`AGENTS.md` 选项的 `available` 字段被设置为 `false`，这表明它是一个特殊的通用选项，适用于与 Amp、VS Code 等兼容的助手。

**Section sources**
- [config.ts](file://src/core/config.ts#L1-L38)

## project.md 文件结构与作用

`openspec/project.md` 文件是 OpenSpec 项目的核心文档，它为开发者和 AI 助手提供了项目的上下文和指导。该文件的结构清晰，涵盖了技术栈、项目结构、约定、错误处理、日志记录、测试策略和开发工作流等关键方面。

文件首先介绍了项目的目标：一个帮助开发者设置 OpenSpec 文件结构并保持 AI 指令更新的最小 CLI 工具。技术栈部分明确指出了项目使用的技术，包括 TypeScript 语言、Node.js 运行时（版本 ≥20.19.0）、pnpm 包管理器、Commander.js CLI 框架和 @inquirer/prompts 用于用户交互。项目结构部分通过代码块展示了 `src/` 目录的组织方式，将 CLI 命令、核心逻辑和实用工具清晰地分离。

`project.md` 的核心作用在于建立项目约定（Conventions），强调了严格模式、异步/等待操作、最小依赖原则以及清晰的代码分层。它还规定了错误处理策略，即让错误冒泡到 CLI 层进行统一的用户消息处理，并使用标准的退出码。日志记录部分提倡直接使用 `console.log()` 和 `console.error()`，避免引入额外的日志库以保持简单性。测试策略建议在开发初期进行手动测试和烟雾测试，仅在复杂度增加时才引入单元测试。最后，开发工作流部分指导开发者如何使用 pnpm、编译 TypeScript 以及通过 `pnpm link` 进行本地测试，确保所有开发活动都遵循 OpenSpec 自身的变更驱动开发流程。

**Section sources**
- [project.md](file://openspec/project.md#L1-L53)

## 模板系统工作原理

OpenSpec 的模板系统位于 `src/core/templates/` 目录下，是生成项目文件和 AI 指令的核心。该系统通过 `TemplateManager` 类进行管理，它负责根据上下文生成和提供各种模板。

`TemplateManager` 类的 `getTemplates` 静态方法返回一个包含 `AGENTS.md` 和 `project.md` 模板的数组。`AGENTS.md` 模板的内容直接来自 `agentsTemplate` 常量，而 `project.md` 模板的内容则通过 `projectTemplate` 函数生成，该函数接受一个 `ProjectContext` 对象作为参数，允许在生成时动态填充项目名称、描述、技术栈等信息。`Template` 接口定义了每个模板必须包含 `path` 和 `content` 属性，其中 `content` 可以是字符串或一个返回字符串的函数，这为动态模板提供了灵活性。

`agents-template.ts` 文件定义了 `agentsTemplate` 常量，这是一个包含详细 AI 助手指令的大型 Markdown 字符串。它涵盖了从创建变更提案到实施和归档的三阶段工作流，以及快速入门、目录结构、创建变更提案的决策树、规范文件格式、故障排除和最佳实践等内容。`project-template.ts` 文件则定义了 `projectTemplate` 函数，它生成 `project.md` 文件的初始内容，包括项目目的、技术栈、代码风格、架构模式、测试策略、Git 工作流、领域上下文、重要约束和外部依赖等占位符。

对于特定的 AI 工具，如 Claude、Cline 和 CoStrict，它们的模板（`claude-template.ts`, `cline-template.ts`, `costrict-template.ts`）实际上都导出了 `agentsRootStubTemplate`，这是一个位于 `agents-root-stub.ts` 中的通用模板。这表明这些工具共享相同的指令基础。此外，`slash-command-templates.ts` 文件定义了用于 `/proposal`, `/apply`, 和 `/archive` 等斜杠命令的模板体，这些模板体包含了特定于每个命令的步骤和参考信息，确保 AI 助手在执行不同命令时遵循正确的流程。

**Section sources**
- [index.ts](file://src/core/templates/index.ts#L1-L51)
- [agents-template.ts](file://src/core/templates/agents-template.ts#L1-L458)
- [project-template.ts](file://src/core/templates/project-template.ts#L1-L38)
- [slash-command-templates.ts](file://src/core/templates/slash-command-templates.ts#L1-L59)

## 高级配置选项

OpenSpec 提供了多种高级配置选项，允许用户通过环境变量或命令行参数进行非交互式设置，从而适应自动化和 CI/CD 环境。

`init.ts` 文件中的 `InitCommand` 类是配置流程的核心。它支持通过 `--tools` 命令行参数进行非交互式配置。用户可以指定 `all` 来启用所有可用工具，指定 `none` 来禁用所有工具，或提供一个逗号分隔的工具 ID 列表（如 `claude,cline`）来精确选择要配置的工具。该参数的解析逻辑在 `resolveToolsArg` 方法中实现，它会验证输入的工具 ID 是否有效，并处理大小写和去重。

`update.ts` 文件中的 `UpdateCommand` 类负责更新现有配置。它会检查 `openspec` 目录是否存在，并自动更新 `AGENTS.md` 文件。对于其他 AI 工具的配置文件，它会检查文件是否存在且可写，然后调用相应的配置器进行更新。如果文件不存在，它会创建新文件；如果更新失败，它会记录错误但不会中断整个流程，确保了更新操作的健壮性。

`configurators` 目录下的配置器（如 `agents.ts`）实现了 `ToolConfigurator` 接口。每个配置器都知道如何配置特定的 AI 工具。例如，`AgentsStandardConfigurator` 负责配置 `AGENTS.md` 文件。它使用 `FileSystemUtils.updateFileWithMarkers` 方法，将模板内容写入文件，并用 `OPENSPEC_MARKERS` 标记包裹，确保内容可以被安全地更新。这种基于标记的更新机制是 OpenSpec 高级配置的基石，允许在不覆盖用户自定义内容的情况下进行自动化更新。

**Section sources**
- [init.ts](file://src/core/init.ts#L371-L971)
- [update.ts](file://src/core/update.ts#L1-L130)
- [agents.ts](file://src/core/configurators/agents.ts#L1-L24)

## 配置最佳实践与用例

为了有效利用 OpenSpec 的配置与自定义功能，遵循以下最佳实践至关重要。

**最佳实践：**
1.  **保持 `project.md` 的更新**：`project.md` 是项目知识的单一来源。当项目的技术栈、架构或约定发生变化时，务必及时更新此文件，以确保所有 AI 助手都能获得最新的上下文。
2.  **利用非交互式初始化**：在自动化脚本或 CI/CD 流水线中，使用 `openspec init --tools all` 或 `openspec init --tools claude,cline` 命令进行非交互式初始化，以提高效率和一致性。
3.  **定期更新配置**：随着 OpenSpec 的更新，新的 AI 工具支持或更好的指令可能会被添加。定期运行 `openspec update` 命令可以确保您的 `AGENTS.md` 和其他配置文件保持最新。
4.  **理解标记机制**：了解 `<!-- OPENSPEC:START -->` 和 `<!-- OPENSPEC:END -->` 标记的作用。避免在这些标记之间手动编辑内容，因为这些内容可能会在下次 `update` 时被覆盖。如果需要添加自定义指令，应将它们放在标记之外。

**常见用例示例：**
1.  **新项目初始化**：在一个新项目中运行 `openspec init`。交互式向导会引导您选择要配置的 AI 工具。选择后，它会创建 `openspec/` 目录结构，并生成 `AGENTS.md` 和 `project.md` 文件。
2.  **向现有项目添加支持**：在一个已有的项目中，运行 `openspec init`。工具会检测到 `openspec/` 目录已存在，并进入“扩展”模式。您可以选择添加对新 AI 工具（如 Kilo Code）的支持，而不会影响现有的配置。
3.  **更新 AI 指令**：当团队决定更改代码风格约定时，首先更新 `openspec/project.md` 中的“代码风格”部分。然后，运行 `openspec update`。此命令会更新 `AGENTS.md` 文件，确保所有 AI 助手都遵循新的约定。
4.  **自动化环境配置**：在 CI/CD 环境中，使用 `openspec init --tools all --no-interactive` 命令来自动配置所有支持的 AI 工具，为自动化测试或代码生成任务做好准备。

通过遵循这些最佳实践和理解这些用例，团队可以充分利用 OpenSpec 的配置系统，确保开发流程的标准化和高效化。

**Section sources**
- [project.md](file://openspec/project.md#L1-L53)
- [init.ts](file://src/core/init.ts#L371-L971)
- [update.ts](file://src/core/update.ts#L1-L130)